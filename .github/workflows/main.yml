name: Zero Trust DevSecOps Pipeline

on:
  push:
    branches: ["main"]

jobs:
  security-and-build:
    runs-on: self-hosted
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Reports Directory
        shell: cmd
        run: if not exist "security-reports" mkdir "security-reports"

     # --- 1. STATIC CODE ANALYSIS (Lint & Flake8) ---
      - name: Static Code Analysis
        shell: cmd
        run: |
          :: Build the image with --no-cache to ensure new requirements are installed
          docker build --no-cache -t test-backend ./backend
          
          echo Running Flake8 (Report Only)...
          docker run --rm test-backend python -m flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics > security-reports/flake8-report.txt

          echo Running Pylint (Report Only - No Fail)...
          :: We use "|| echo" to print a message if issues are found
          docker run --rm test-backend python -m pylint --fail-under=8.0 main.py > security-reports/pylint-report.txt || echo Pylint found issues (ignoring for now)...
          
          :: FORCE SUCCESS: This ensures the step does not fail even if Pylint returned code 20
          exit 0

      # --- 2. UNIT TESTING (Pytest) ---
      - name: Run Backend Unit Tests
        shell: cmd
        run: |
          docker run --rm -v "%GITHUB_WORKSPACE%\security-reports:/app/reports" test-backend sh -c "pytest --cov=. --cov-report=html:/app/reports/coverage-report.html"

      # --- 3. SONARQUBE SCAN ---
      - name: SonarQube Scan
        shell: cmd
        env:
          SONAR_TOKEN_VAR: ${{ secrets.SONAR_TOKEN }}
        run: |
          docker run --rm ^
            -e SONAR_HOST_URL="http://host.docker.internal:9000" ^
            -v "%GITHUB_WORKSPACE%:/usr/src" ^
            sonarsource/sonar-scanner-cli ^
            -Dsonar.projectKey=zero-trust-app ^
            -Dsonar.token="%SONAR_TOKEN_VAR%" ^
            -Dsonar.sources=. ^
            -Dsonar.exclusions=**/node_modules/**,**/.git/**,**/__pycache__/**,**/tests/** ^
            -Dsonar.python.coverage.reportPaths=security-reports/coverage.xml ^
            -Dsonar.qualitygate.wait=true

      # --- 4. TRIVY FILESYSTEM SCAN (Split: Report + Gate) ---
      - name: Trivy FS Scan - Report Generation
        shell: cmd
        run: |
          docker run --rm ^
            -v "%GITHUB_WORKSPACE%:/usr/src" ^
            -v "%GITHUB_WORKSPACE%\security-reports:/reports" ^
            -w /usr/src ^
            aquasec/trivy fs --format template --template "@/contrib/html.tpl" ^
            --output /reports/fs-report.html --exit-code 0 ^
            --skip-dirs .git --skip-dirs .github --skip-dirs node_modules --skip-dirs __pycache__ ^
            .

      - name: Trivy FS Scan - Quality Gate (Fail on Critical)
        shell: cmd
        run: |
          docker run --rm ^
            -v "%GITHUB_WORKSPACE%:/usr/src" ^
            aquasec/trivy fs --exit-code 1 --severity CRITICAL ^
            --skip-dirs .git --skip-dirs .github --skip-dirs node_modules --skip-dirs __pycache__ ^
            .

      # --- 5. DOCKER LOGIN & BUILD ---
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Images
        shell: cmd
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          docker build -t %DOCKER_USER%/zero-trust-backend:latest ./backend
          docker build -t %DOCKER_USER%/zero-trust-frontend:latest ./frontend

      # --- 6. TRIVY IMAGE SCAN (Using your working syntax) ---
      
      # 6a. Backend Image
      - name: Trivy Scan Backend
        shell: cmd
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          :: Report
          docker run --rm -v //./pipe/docker_engine://./pipe/docker_engine -v "%GITHUB_WORKSPACE%\security-reports:/reports" ^
            aquasec/trivy image --format template --template "@/contrib/html.tpl" ^
            --output /reports/backend-image-report.html --exit-code 0 ^
            %DOCKER_USER%/zero-trust-backend:latest
          
          :: Gate
          docker run --rm -v //./pipe/docker_engine://./pipe/docker_engine ^
            aquasec/trivy image --exit-code 1 --severity CRITICAL ^
            %DOCKER_USER%/zero-trust-backend:latest

      # 6b. Frontend Image
      - name: Trivy Scan Frontend
        shell: cmd
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          :: Report
          docker run --rm -v //./pipe/docker_engine://./pipe/docker_engine -v "%GITHUB_WORKSPACE%\security-reports:/reports" ^
            aquasec/trivy image --format template --template "@/contrib/html.tpl" ^
            --output /reports/frontend-image-report.html --exit-code 0 ^
            %DOCKER_USER%/zero-trust-frontend:latest
            
          :: Gate
          docker run --rm -v //./pipe/docker_engine://./pipe/docker_engine ^
            aquasec/trivy image --exit-code 1 --severity CRITICAL ^
            %DOCKER_USER%/zero-trust-frontend:latest
      # --- 7. UPLOAD ARTIFACTS ---
      - name: Upload Security Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: DevSecOps-Reports
          path: |
            security-reports/*.html
            security-reports/*.txt

      # --- 8. PUSH & DEPLOY ---
      - name: Push & Deploy
        shell: cmd
        env:
          DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          docker push %DOCKER_USER%/zero-trust-backend:latest
          docker push %DOCKER_USER%/zero-trust-frontend:latest
          
          docker-compose down
          docker-compose pull
          docker-compose up -d vault mongodb
          timeout /t 10 /nobreak
          setup-vault.bat
          docker-compose up -d --build backend frontend vault-agent

      # --- 9. CLEANUP ---
      - name: Cleanup
        if: always()
        shell: cmd
        run: if exist "security-reports" rd /s /q "security-reports"
